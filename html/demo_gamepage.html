<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/ITW-2025/style/game_page.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamePage</title>
    <style>
        #gnav {
            height: 30px;
            text-align: center;
        }
        #mine-total {
            width: 30px;
            text-align: center;
        }
        #timer {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="mainWindow">
        <div class="header">
            <a href="home_page.html"><img src="media/house_icon.png" alt="Home" id="house" class="banner_button_image"></a>
        </div>

        <div class="content">
            <div class="game_window">
                <div id="minesweeper-wrapper">
                    <div id="gnav">
                        <input type="text" id="mine-total" />
                        <input type="radio" name="level" id="level_1" onchange="select_lev(0)" checked />
                        <label for="level_1">Facil</label>
                        <input type="radio" name="level" id="level_2" onchange="select_lev(1)" />
                        <label for="level_2">Intermedio</label>
                        <input type="radio" name="level" id="level_3" onchange="select_lev(2)" />
                        <label for="level_3">Dificil</label>
                        <button id="btn" onclick="select_lev()">Restart</button>
                        <input type="text" id="timer" />
                    </div>
                    <canvas id="mycanv"></canvas>
                </div>
            </div>

            <div class="last_row_buttons">
                <a href="rules_page.html"><img src="media/info_icon.png" alt="Rules" id="info" class="banner_button_image"></a>
                <a href="statistics_page.html"><img src="media/stat.png" alt="Stats" id="stats" class="banner_button_image"></a>
            </div>
        </div>
    </div>
    <script>
        /**@type{HTMLCanvasElement}*/ //vsCode
        var gnav = document.getElementById('gnav');
        var mine_total = document.getElementById('mine-total');
        var mine_timer = document.getElementById('timer');
        var canv = document.getElementById('mycanv');
        var ctx = canv.getContext('2d');
        //æ¸¸æˆç­‰çº§ä¿¡æ¯
        var levels = [
            [9, 9, 10],
            [16, 16, 40],
            [16, 30, 99],
        ];
        //é¢„è®¾æ¸¸æˆç­‰çº§0
        var level = 0;
        var g = levels[level];//å½“å‰æ¸¸æˆç­‰çº§ä¿¡æ¯
        var g_arr = [];//æ¸¸æˆå—idåˆ—è¡¨
        var g_info = {};//æ¯ä¸ªå—çš„æ¸¸æˆä¿¡æ¯
        var g_color = {//é¢„è®¾æ¸¸æˆå—é¢œè‰²
            block: '#369',
            open: '#ddd',
            mine: '#69f',
            bomb: '#f66',
            highlight: '#69d',
        };
        var mine_arr = [];//å½“å‰æ¸¸æˆé›·å—idåˆ—è¡¨
        var count = 0;//å·²æ ‡è®°é›·å—ç»Ÿè®¡
        var over = false;//æ¸¸æˆæ˜¯å¦ç»“æŸ
        var win = false;//æ¸¸æˆæ˜¯å¦è·èƒœ
        var XY = '';//æ„é€ xy
        var gblock = {//å¸ƒå±€,æ¸¸æˆå—å°ºå¯¸:å®½åº¦,åœ†è§’,å¤–è¾¹è·
            width: 50,
            radius: 6,
            margin: 2,
        };
        var mine = ['ğŸ’£', 'ğŸš©', 'â”', 'ğŸ’¥'];//é¢„è®¾é›·å—æ ‡è®°ç¬¦å·
        var gamestart = 0;//æ¸¸æˆæ˜¯å¦å¼€å§‹
        var ttimer = 0;//æ¸¸æˆè®¡æ—¶å™¨
        var durtime = 0;//æ¸¸æˆè€—æ—¶è®°å½•
        g_init();
        //åˆå§‹åŒ–
        function g_init() {//åˆå§‹åŒ–å¸ƒå±€åŠæ¸¸æˆä¿¡æ¯
        //------é‡ç½®æ¸¸æˆåŸºç¡€ä¿¡æ¯------
            g_arr = [];
            mine_arr = [];
            count = 0;
            over = false;
            win = false;
            gamestart = 0;
            durtime = 0;
            clearInterval(ttimer);//æ¸…é™¤å®šæ—¶å™¨
            g = levels[level];//è·å–æ¸¸æˆç­‰çº§,é‡ç½®æ¸¸æˆç”»å¸ƒåŠç›¸å…³æ¸¸æˆæ•°æ®
            gnav.style.width = g[1] * gblock.width + 'px';
            mine_total.value = g[2];
            mine_timer.value = 0;
            let h = g[0] * gblock.width;
            let w = g[1] * gblock.width;
            canv.height = h;
            canv.width = w;
            ctx.clearRect(0, 0, w, h);//æ¸…é™¤ç”»å¸ƒ
            //æŒ‰è¡Œåˆ—è¾“å‡ºæ¸¸æˆå—
            for (let i = 0; i < g[0]; i++) {
                for (let j = 0; j < g[1]; j++) {
                    let xy = j + '-' + i;//æ ¹æ®åæ ‡æ„é€ æ¸¸æˆå—id
                    g_arr.push(xy);//g_arrè®°å½•æ¸¸æˆå—id
                    g_info[xy] = {//å¯¹æ¯ä¸ªæ¸¸æˆå—, é¢„è®¾æ¸¸æˆä¿¡æ¯: 
                        mark: 0,//mark:æ•°å­—æ ‡è®°0-8æˆ–é›·æ ‡è®°-1;
                        open: 0,//open:æ¸¸æˆå—æ‰“å¼€çŠ¶æ€:0æœªæ‰“å¼€/1å·²æ‰“å¼€/-1æ ‡è®°é›·å—/-2ç–‘ä¼¼é›·å—
                    };
                    drawBlock(xy, g_color.block);//ç»˜åˆ¶: å—,é¢œè‰²
                }
            }
            //éšæœºå¸ƒé›·
            setMine();
            // showInfo();
        }

        function select_lev(lv) {//é€‰æ‹©æ¸¸æˆç­‰çº§
            level = lv || level;
            g_init();
        }

        function drawBlock(xy, c) {//ç»˜åˆ¶æ¸¸æˆå—: åœ†è§’çŸ©å½¢
            let [x, y] = xy.split('-').map(n => n * gblock.width);//è§£æid,å¹¶æ„é€ åæ ‡
            let w = gblock.width - gblock.margin;
            let r = gblock.radius;
            ctx.clearRect(x, y, gblock.width, gblock.width); 
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, y + gblock.radius);
            ctx.arcTo(x, y + w, x + w, y + w, r);
            ctx.arcTo(x + w, y + w, x + w, y, r);
            ctx.arcTo(x + w, y, x, y, r);
            ctx.arcTo(x, y, x, y + w, r);
            ctx.closePath();
            ctx.fillStyle = c;
            ctx.fill();
            ctx.restore();
        }

        function setMine() {//éšæœºå¸ƒé›·: ç”Ÿæˆé›·å—åˆ—è¡¨mine_arr,æ›´æ–°æ¸¸æˆå—ä¿¡æ¯g_info:æ ‡è®°ä¸ºé›·æˆ–è®¡ç®—æ•°å­—
        //å¯¹æ¸¸æˆå—éšæœºæ‰“ä¹±,æå–å®šé‡é›·å—
            mine_arr = g_arr.sort(() => Math.random() - 0.5).slice(0, g[2]);
            mine_arr.forEach(xy => {
                g_info[xy].mark = -1;//å°†æ¸¸æˆå—æ ‡è®°ä¸ºé›·-1
                getAround(xy).forEach(n => {//è·å–å½“å‰é›·å—å‘¨è¾¹8å—: è®¡ç®—æ•°å­—
                    if (g_info[n].mark != -1) g_info[n].mark++;//æ¯å¸ƒä¸€ä¸ªé›·,å¯¹äºå‘¨è¾¹éé›·å—æ•°å­—+1
                });
            });
        }

        function getAround(xy) {//è·å–å½“å‰æ¸¸æˆå—çš„å‘¨è¾¹æœ‰æ•ˆå—
            let [x, y] = xy.split('-').map(n => n * 1);
            let around = [];
            //å·¦ä¸­å³,ä¸Šä¸­ä¸‹
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    //æ„é€ æ¸¸æˆå—id
                    let id = `${x + i}-${y + j}`;
                    //åˆ¤æ–­idæ˜¯å¦æœ‰æ•ˆ:åœ¨æ¸¸æˆå—æ•°ç»„g_arrä¸­åŒ…å«, å¹¶æ’é™¤è‡ªèº«å—;
                    if (g_arr.includes(id) && id != xy) around.push(id);
                }
            }
            return around;
        }

        function markText(xy, text) {//åœ¨æ¸¸æˆå—ä¸Šæ ‡æ³¨æ–‡æœ¬: æ•°å­—æˆ–é›·å—æ ‡è®°
            let [x, y] = xy.split('-').map(n => n * gblock.width);
            ctx.save();
            ctx.fillStyle = '#111';
            ctx.font = '20px arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x + gblock.width / 2, y + gblock.width / 2);
            ctx.restore();
        }
        //è¾…åŠ©æ˜¾ç¤º
        function showInfo() {//è¾…åŠ©æ˜¾ç¤ºå¸ƒé›·æƒ…å†µä¿¡æ¯, æ˜¾ç¤ºæ•°å­—å’Œé›·å—æ ‡è®°
            g_arr.forEach(xy => {
                if (g_info[xy].mark == -1) {
                    drawBlock(xy, g_color.mine);
                } else {
                    //æ˜¾ç¤ºæ•°å­—
                    drawBlock(xy, g_color.block);
                    markText(xy, g_info[xy].mark);
                }
            });
        }
        //é¼ æ ‡äº‹ä»¶:
        //1,å·¦é”®ç‚¹å‡»click(æœªæ‰“å¼€å—)æ‰“å¼€æ¸¸æˆå—(æ™®é€šæ•°å­—å—,ç©ºç™½åŒºé€’å½’æ¸…é›¶,é›·å—è§¦é›·å¤±è´¥)
        //2,å³é”®ç‚¹å‡»contextmenu(æœªæ‰“å¼€å—)æ ‡è®°æ¸¸æˆå—(æ ‡è®°é›·å—,æ ‡è®°ç–‘ä¼¼é›·å—,å–æ¶ˆæ ‡è®°)
        //3,ç‚¹å‡»å·²æ‰“å¼€çš„å—: mousedownæŒ‰ä¸‹é¼ æ ‡é«˜äº®å‘¨è¾¹; mouseupæ¾å¼€é¼ æ ‡å–æ¶ˆé«˜äº®,*è¾…åŠ©æ‰«é›·;
        canv.addEventListener('click', openBlock);
        canv.addEventListener('contextmenu', markMine);
        canv.addEventListener('mousedown', highLight);
        canv.addEventListener('mouseup', supGame);

        function highLight(ev) {//å³å‡»éé›·å—,è¾…åŠ©: é«˜äº®å‘¨è¾¹
            if (over) return;
            //è·å–æ­£ç¡®åæ ‡
            let x = ~~(ev.offsetX / gblock.width);
            let y = ~~(ev.offsetY / gblock.width);
            let xy = x + '-' + y;
            if (g_info[xy].open == 1) getAround(xy).forEach(n => {
                if (g_info[n].open == 0) {
                    drawBlock(n, g_color.highlight);
                }
            });
        }

        function startTimer() {//æ¸¸æˆå¼€å§‹è®¡æ—¶
            ttimer = setInterval(() => {
                durtime++;
                mine_timer.value = (durtime / 10).toFixed(1);
            }, 100);
        }

        function supGame(ev) {//å³å‡»éé›·å—,è¾…åŠ©: é¼ æ ‡æŒ‰ä¸‹é«˜äº®,é¼ æ ‡æ¾å¼€å–æ¶ˆé«˜äº®å¹¶æ ‡æ³¨ç¡®å®šçš„æ¸¸æˆå—(æ‰“å¼€æˆ–æ ‡è®°é›·)
            if (over) return;
            //è·å–æ­£ç¡®åæ ‡
            let x = ~~(ev.offsetX / gblock.width);
            let y = ~~(ev.offsetY / gblock.width);
            let xy = x + '-' + y;
            if (g_info[xy].open == 1) {
                let around = getAround(xy);//è·å–å½“å‰æ¸¸æˆå—å‘¨è¾¹
                let mark = g_info[xy].mark;
                let marked_mine = 0;//å·²æ ‡è®°é›·å—æ•°é‡
                let unopen = 0;//æœªæ‰“å¼€å—æ•°é‡
                around.forEach(n => {//ç»Ÿè®¡å‘¨è¾¹æ¸¸æˆå—ä¿¡æ¯: æœªæ‰“å¼€å—æ•°é‡å’Œå·²æ ‡è®°é›·æ•°é‡
                    if (g_info[n].open == 0 || g_info[n].open == -2) unopen++;
                    if (g_info[n].open == -1) marked_mine++;
                });
                around.forEach(n => {//éå†å‘¨è¾¹å—,
                    if (g_info[n].open == 0) {
                        drawBlock(n, g_color.block);//å–æ¶ˆé«˜äº®
                        //è¾…åŠ©æ‰«é›·
                        if (mark == marked_mine) {//å¦‚æœå½“å‰æ•°å­—ç­‰äºå·²ç»æ ‡è®°çš„é›·å—:é›·å·²ç»å…¨éƒ¨æ’å‡º, å…¶ä»–ä¸ºå®‰å…¨å—
                            g_info[n].open = 1;//å®‰å…¨å—,è‡ªåŠ¨æ‰“å¼€
                            drawBlock(n, g_color.open);
                            markText(n, g_info[n].mark);
                            if (g_info[n].mark == 0) openZero(n);//å¦‚æœæ˜¯0å—, é€’å½’æ¸…é›¶(0å—è¯´æ˜å‘¨è¾¹æ²¡æœ‰é›·)
                            if (g_info[n].mark == -1) {//åœ¨å®‰å…¨å—ä¸­é‡åˆ°é›·(è¯´æ˜æ ‡è®°äº†é”™è¯¯é›·å—)
                                drawBlock(n, g_color.bomb);
                                markText(n, mine[0]);
                                markText(n, mine[3]);
                                checkOver(true);//æ¸¸æˆç»“æŸ
                            }
                        } else if (unopen == mark - marked_mine) {//å¦‚æœå‰©ä½™çš„å—éƒ½æ˜¯é›·, åˆ™ç›´æ¥æ ‡æ³¨é›·
                            g_info[n].open = -1;
                            drawBlock(n, g_color.mine);
                            markText(n, mine[1]);
                            count++;
                            mine_total.value = g[2] - count;
                            if (count == g[2]) checkOver();//æ ‡è®°é›·ä¹‹å, åˆ¤æ–­æ•°é‡, æ˜¯å¦å®Œæˆæ‰«é›·
                        }
                    }
                });
            }
        }

        function openBlock(ev) {//å·¦é”®å•å‡»,æ‰“å¼€æ¸¸æˆå—
            if (over) return;
            if (gamestart == 0) {//æ‰“å¼€ç¬¬ä¸€ä¸ªå—,æ¸¸æˆå¼€å§‹æ ‡è®°
                gamestart = 1;
                startTimer();
            }
            //è·å–æ­£ç¡®åæ ‡
            let x = ~~(ev.offsetX / gblock.width);
            let y = ~~(ev.offsetY / gblock.width);
            let xy = x + '-' + y;
            if (g_info[xy].open == 0) {//ä»…å¯¹æœªæ‰“å¼€çš„æ¸¸æˆå—æœ‰æ•ˆ
                g_info[xy].open = 1;//å¸¸è§„æ ‡æ³¨,æ ‡è®°æ‰“å¼€çŠ¶æ€
                drawBlock(xy, g_color.open);
                markText(xy, g_info[xy].mark);
                if (g_info[xy].mark == 0) {//é‡åˆ°0å—, é€’å½’æ¸…é›¶
                    openZero(xy);
                } else if (g_info[xy].mark == -1) {//ç‚¹çˆ†é›·å—, æ¸¸æˆç»“æŸ
                    drawBlock(xy, g_color.bomb);
                    markText(xy, mine[0]);
                    markText(xy, mine[3]);
                    checkOver(true);
                }
            }
        }

        function openZero(xy) {//é€’å½’æ¸…é›¶,é‡åˆ°0å—è¯´æ˜å‘¨è¾¹å®‰å…¨,å¯ä»¥å…¨éƒ¨æ‰“å¼€
            getAround(xy).forEach(n => {
                if (g_info[n].open == 0) {
                    g_info[n].open = 1;
                    drawBlock(n, g_color.open);
                    markText(n, g_info[n].mark);
                    if (g_info[n].mark == 0) openZero(n);
                }
            });
        }

        function checkOver(bomb) {//åˆ¤æ–­æ¸¸æˆç»“æŸ,
            over = true;
            clearInterval(ttimer);
            //åˆ¤æ–­æ˜¯å¦è·èƒœ:æ‰€æœ‰æ ‡æ³¨çš„é›·å—open-1æ˜¯å¦å’Œå¯¹åº”çš„mark-1ä¸€è‡´.
            //bomb:å·¦é”®ç‚¹çˆ†é›·,æˆ–è¾…åŠ©æ‰«é›·ç‚¹çˆ†,æ¸¸æˆç›´æ¥å¤±è´¥ç»“æŸ
            win = bomb ? false : mine_arr.every(xy => g_info[xy].mark == g_info[xy].open);
            setTimeout(() => {//å»¶è¿Ÿå¼¹çª—,ç¡®å®š:é‡ç©
                let restart = confirm(win ? `æ­å–œèƒœåˆ©!\nè€—æ—¶ï¼š${(durtime/10).toFixed(1)}ç§’` : 'æŒ‘æˆ˜å¤±è´¥~');
                if (restart) g_init();
            }, 100);
        }

        function markMine(ev) {//å³é”®æ ‡æ³¨é›·å—
            //ç¦ç”¨å³é”®çš„æµè§ˆå™¨é»˜è®¤èœå•:é˜»æ­¢é»˜è®¤åŠ¨ä½œ
            ev.preventDefault();
            if (over) return;
            if (gamestart == 0) {
                gamestart = 1;
                startTimer();
            }
            //è·å–æ­£ç¡®åæ ‡
            let x = ~~(ev.offsetX / gblock.width);
            let y = ~~(ev.offsetY / gblock.width);
            let xy = x + '-' + y;
            if (g_info[xy].open == 0) {//å¦‚æœæ˜¯æœªæ‰“å¼€å—, æ ‡æ³¨é›·-1
                g_info[xy].open = -1;
                drawBlock(xy, g_color.mine);
                markText(xy, mine[1]);
                count++;
                mine_total.value = g[2] - count;
                if (count == g[2]) checkOver();
            } else if (g_info[xy].open == -1) {//å¦‚æœå·²æ ‡æ³¨é›·-1, åˆ™æ ‡æ³¨ä¸ºç–‘ä¼¼é›·-2
                g_info[xy].open = -2;
                drawBlock(xy, g_color.mine);
                markText(xy, mine[2]);
                count--;
                mine_total.value = g[2] - count;
            } else if (g_info[xy].open == -2) {//å¦‚æœæ ‡æ³¨ç–‘ä¼¼é›·-2, åˆ™æ¢å¤æœªæ‰“å¼€çŠ¶æ€0
                g_info[xy].open = 0;
                drawBlock(xy, g_color.block);
            }
        }
    </script>
</body>
</html>
